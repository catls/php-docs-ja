#!/bin/bash

BASE_DIR=$(cd $(dirname $0)/../;pwd)
TMP_DIR=${BASE_DIR}/tmp
DOC_DIR=${BASE_DIR}/php-chunked-xhtml

[ ! -d $TMP_DIR ] && mkdir -p $TMP_DIR
[ ! -f ${TMP_DIR}/update-date ] && touch ${TMP_DIR}/update-date

function check_update() {
    local _CHECK_URL="http://www.php.net/download-docs.php";

    cd ${TMP_DIR}

    wget ${_CHECK_URL} -O check.html > /dev/null 2>&1
    UPDATED_TIME=$(grep 'Date:' check.html | grep php_manual_ja.tar.gz | egrep -o 'Date:\s?([0-9]{1,2} [a-zA-Z]{3} [0-9]{4})')
    if [ -z "$UPDATED_TIME" ];then
        echo '$UPDATE_TIMEの取得に失敗しました。'
        return 0
    fi
    if grep "${UPDATED_TIME}" update-date >/dev/null;then
        return 0
    else
        echo "更新を確認しました。${UPDATED_TIME}"
        echo ${UPDATED_TIME} > update-date
        return 1
    fi
}
function update() {
    local _TAR_URL="http://jp2.php.net/get/php_manual_ja.tar.gz/from/this/mirror";

    cd ${TMP_DIR}

    wget ${_TAR_URL} -O php_manual_ja.tar.gz  > /dev/null 2>&1
    if [ "$?" -ne 0 ];then
        echo "php_manual_ja.tar.gzの取得に失敗しました。"
        return 0
    fi

    tar xzf php_manual_ja.tar.gz && rm php_manual_ja.tar.gz

    rm -fr ${DOC_DIR}
    mv ${TMP_DIR}/php-chunked-xhtml ${DOC_DIR}

    return 1
}
function git_commit() {
    cd ${BASE_DIR}

    git add -A .
    git commit -am "updated ${UPDATED_TIME}"
    git push origin master

    echo "php-docs-jaを更新しました。${UPDATED_TIME}"
    echo "HEAD :$(git rev-parse HEAD)"
    echo "HEAD^:$(git rev-parse HEAD^)"
}

check_update || update || git_commit
